<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Agri Masala - Premium Spice Blend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="/user/css/product_details.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

</head>
<style>
  .review-card {
    transition: all 0.3s ease-in-out;
  }

  .review-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .review-card .fa-user-circle {
    color: #0d6efd;
  }

  .card select {
    font-size: 14px;
    padding: 5px 10px;
  }

  .card .price-display {
    font-size: 16px;
  }
</style>

<body>
  <!-- Decorative spice elements -->
  <div class="spice-decoration" style="top: 50px; left: 50px;">üå∂Ô∏è</div>
  <div class="spice-decoration" style="top: 150px; right: 50px;">üßÖ</div>
  <div class="spice-decoration" style="bottom: 100px; left: 100px;">üßÑ</div>

  <div class="container py-4">
    <!-- Page Header -->
    <div class="page-header">
      <h1>
        <%= product.product_name %>
      </h1>
      <p>
        <%= product.detail %>
      </p>
    </div>

    <div class="row g-5">
      <!-- Image Flip -->
      <div class="col-lg-6">
        <div class="image-flip-container">
          <div class="image-flip-inner">
            <img src="/uploads/<%= product.image %>" class="image-front" alt="Agri Masala Front">
            <img src="/uploads/<%= product.image2 %>" class="image-back" alt="Agri Masala Back">
          </div>
        </div>
        <div class="text-center mt-4">
          <p class="text-muted">Hover over the image to see the ingredients</p>
        </div>

        <div>
          <h5>Product Usage:</h5>
          <p>
            <%=product.usage%>
          </p>
        </div>
        <div>
          <h5>Health Benifits:</h5>
          <p>
            <%=product.health_benifits%>
          </p>
        </div>

      </div>

      <!-- Product Info -->
      <div class="col-lg-6">
        <div class="product-card">
          <h1 class="product-name">
            <%= product.product_name %>
          </h1>
          <p class="product-subtitle">
            <%= product.detail %>
          </p>

          <!-- <div class="price-badge" id="dynamicPrice">
            <i class="fas fa-tag me-2"></i>‚Çπ<%= variants[0]?.price || '0.00' %>
          </div> -->
          <div id="priceContainer" class="mb-3 d-flex align-items-center gap-3">
            <span id="originalPrice" class="original-price shadow-sm px-3 py-1 rounded-pill bg-light">
              ‚Çπ
            </span>
            <span id="discountedPrice" class="discounted-price">
              <i class="fas fa-tag me-2"></i>‚Çπ.00
            </span>
          </div>



          <div class="mb-4">
            <label for="weightSelect" class="form-label fw-medium">Choose Weight:</label>
            <select class="form-select" id="weightSelect">
              <% variants.forEach(v=> { %>
                <option value="<%= v.id %>" data-price="<%= v.price %>">
                  <%= v.weight %> - ‚Çπ<%= v.price %>
                </option>
                <% }) %>
            </select>
          </div>

          <div class="d-flex align-items-center mb-3 gap-2">
            <label class="fw-medium me-2">Quantity:</label>
            <button class="btn btn-sm btn-outline-secondary" onclick="updateQty(-1)">‚àí</button>
            <input type="number" id="qty" name="quantity" class="form-control text-center" value="1" min="1"
              style="width: 60px;">
            <button class="btn btn-sm btn-outline-secondary" onclick="updateQty(1)">+</button>
          </div>

          <form action="/add_tocart" method="POST">
            <input type="hidden" name="product_id" value="<%= product.product_id %>">
            <input type="hidden" name="product_name" value="<%= product.product_name %>">
            <input type="hidden" name="weight_id" id="formWeight">
            <input type="hidden" name="quantity" id="formQty" value="1">
            <input type="hidden" name="price" id="originalPriceInput">
            <input type="hidden" name="discount_price" id="discountPriceInput">


            <button class="btn-product-custom w-100" type="submit" >
              <i class="fas fa-shopping-cart me-2"></i>Add to Cart
            </button>
          </form>
          <br><br>

          <h5 class="section-title">Ingredients</h5>
          <div class="ingredient-list">
            <% product.ingredients.split(',').forEach(item=> { %>
              <div class="ingredient-item">
                <%= item.trim() %>
              </div>
              <% }) %>
          </div>


        </div>
      </div>
    </div>

    <!-- reviews -->
    <hr class="my-5" />
    <div class="row">
      <div class="col-lg-7">
        <h4 class="mb-4 fw-semibold">Customer Reviews</h4>
        <% if (reviews && reviews.length> 0) { %>
          <% reviews.forEach(review=> { %>
            <div class="review-card p-3 mb-3 rounded shadow-sm bg-white">
              <div class="d-flex justify-content-between mb-1">
                <h6 class="mb-0 text-primary"><i class="fas fa-user-circle me-1"></i>
                  <%= review.username %>
                </h6>
                <small class="text-muted">
                  <%= new Date(review.date).toLocaleDateString() %>
                </small>
              </div>
              <div class="mb-2 text-warning">
                <% for(let i=0; i < review.rating; i++) { %>
                  <i class="fas fa-star"></i>
                  <% } %>
                    <% for(let i=review.rating; i < 5; i++) { %>
                      <i class="far fa-star"></i>
                      <% } %>
              </div>
              <p class="mb-0 text-dark">
                <%= review.comment %>
              </p>
            </div>
            <% }) %>
              <% } else { %>
                <p class="text-muted">No reviews yet. Be the first to share your experience!</p>
                <% } %>
      </div>

      <!-- Review Submission Form -->
      <div class="col-lg-5">
        <div class="p-4 rounded bg-light shadow-sm">
          <h5 class="mb-3 fw-semibold">Write a Review</h5>
          <form action="/submit_review" method="POST">
            <input type="hidden" name="product_id" value="<%= product.product_id %>">

            <div class="mb-3">
              <label class="form-label">Your Name</label>
              <input type="text" class="form-control" name="username" placeholder="Enter your name" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Rating</label>
              <select name="rating" class="form-select" required>
                <option value="">Select Rating</option>
                <option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è - Excellent</option>
                <option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è - Very Good</option>
                <option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è - Good</option>
                <option value="2">‚≠êÔ∏è‚≠êÔ∏è - Fair</option>
                <option value="1">‚≠êÔ∏è - Poor</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Your Review</label>
              <textarea name="comment" class="form-control" placeholder="Share your experience..." rows="3"
                required></textarea>
            </div>

            <button type="submit" class="btn btn-success w-100">
              <i class="fas fa-paper-plane me-2"></i>Submit Review
            </button>
          </form>
        </div>
      </div>
    </div>

    <h3 class="mt-5 mb-4 fw-bold text-uppercase">RELATED PRODUCTS</h3>

    <div class="row g-4">
      <% related.forEach(p=> {
        const variants = relatedVariantsMap[p.product_id] || [];
        %>
        <div class="col-sm-6 col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm border-0 rounded-4 text-center p-3">
            <!-- Product Image -->
            <img src="/uploads/<%= p.image %>" class="img-fluid mb-3" style="height: 180px; object-fit: contain;"
              alt="<%= p.product_name %>">

            <!-- Product Name -->
            <h6 class="fw-bold text-dark">
              <%= p.product_name %>
            </h6>

            <!-- Price -->
            <% if (variants.length> 0) { %>
              <p class="text-success fw-semibold">‚Çπ<%= variants[0].price %>
              </p>

              <!-- Dropdown -->
              <select class="form-select mb-2 text-center" onchange="updateCardPrice(this)">
                <% variants.forEach(v=> { %>
                  <option value="<%= v.price %>">
                    <%= v.weight %> - ‚Çπ<%= v.price %>
                  </option>
                  <% }) %>
              </select>

              <!-- Final Price Display -->
              <div class="price-display fw-semibold text-dark">‚Çπ<%= variants[0].price %>
              </div>
              <% } else { %>
                <p class="text-muted">No variants available</p>
                <% } %>

                  <!-- View Button -->
                  <a href="/product_details/<%= p.product_id %>" class="btn btn-warning mt-2 w-100">
                    <i class="fas fa-eye me-1"></i> View
                  </a>
          </div>
        </div>
        <% }) %>
    </div>


  </div>

  <br><br>

  <!-- JavaScript -->
  <script>
    const weightSelect = document.getElementById('weightSelect');
    const discountedPrice = document.getElementById('discountedPrice');
    const originalPrice = document.getElementById('originalPrice');
    const formWeight = document.getElementById('formWeight');
    const qtyInput = document.getElementById('qty');
    const formQty = document.getElementById('formQty');
    const addToCartForm = document.querySelector("form");
    const addToCartButton = addToCartForm.querySelector("button[type='submit']");

    // New references to correct hidden fields
    const originalPriceInput = document.getElementById("originalPriceInput");
    const discountPriceInput = document.getElementById("discountPriceInput");

    // Get discount percentage from backend
    const discountPercentage = <%= product.discount || 0 %>;

    function updateFormValues() {
      const selectedOption = weightSelect.options[weightSelect.selectedIndex];
      const price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
      const weightId = selectedOption.value;

      const discountAmount = (price * discountPercentage) / 100;
      const finalPrice = (price - discountAmount).toFixed(2);

      // Update UI display
      originalPrice.innerText = `‚Çπ${price.toFixed(2)}`;
      discountedPrice.innerHTML = `<i class="fas fa-tag me-2"></i>‚Çπ${finalPrice}`;

      // Set hidden input values for form submission
      formWeight.value = weightId;
      originalPriceInput.value = price.toFixed(2); // full price
      discountPriceInput.value = finalPrice;       // discounted price
    }

    function updateQty(change) {
      let qty = parseInt(qtyInput.value) + change;
      if (qty < 1) qty = 1;
      qtyInput.value = qty;
      formQty.value = qty;
    }

    qtyInput.addEventListener("input", () => {
      formQty.value = qtyInput.value;
    });

    addToCartForm.addEventListener("submit", () => {
      addToCartButton.disabled = true;
      addToCartButton.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Adding...`;
    });

    window.onload = () => {
      updateFormValues();
      formQty.value = qtyInput.value;
    };

    weightSelect.addEventListener('change', updateFormValues);
  </script>


  <script>
    function updateCardPrice(selectEl) {
      const selectedPrice = selectEl.value;
      const card = selectEl.closest('.card');
      const priceDisplay = card.querySelector('.price-display');
      priceDisplay.textContent = `‚Çπ${selectedPrice}`;
    }
  </script>


</body>

</html>